// Webapp Pipeline - Next.js Application
// Build method: Kaniko (production-ready, no privileged mode)

pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: webapp-builder
spec:
  serviceAccountName: jenkins
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.19.0-debug
    command: ["/busybox/cat"]
    tty: true
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1000m"
    volumeMounts:
    - name: kaniko-secret
      mountPath: /kaniko/.docker

  - name: shell
    image: alpine/git:latest
    command: [cat]
    tty: true
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"

  - name: trivy
    image: aquasec/trivy:latest
    command: [cat]
    tty: true
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"

  volumes:
  - name: kaniko-secret
    secret:
      secretName: harbor-registry-secret
      items:
      - key: .dockerconfigjson
        path: config.json
'''
        }
    }

    environment {
        // Application
        APP_NAME = 'webapp'

        // Vault
        VAULT_ADDR = 'http://vault.vault.svc.cluster.local:8200'

        // Harbor
        HARBOR_REGISTRY = 'harbor.local'
        HARBOR_PROJECT = 'sample-app'
        IMAGE_NAME = "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${APP_NAME}"

        // Version
        GIT_COMMIT_SHORT = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
        BUILD_TAG = "${env.BUILD_NUMBER}-${GIT_COMMIT_SHORT}"

        // Repository
        K8S_REPO = 'https://github.com/chanon-dev/poc-deploy-k8s.git'
        K8S_BRANCH = 'main'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 20, unit: 'MINUTES')
    }

    stages {
        stage('Vault Login') {
            steps {
                container('shell') {
                    script {
                        echo "ðŸ” Authenticating with Vault..."

                        withCredentials([
                            string(credentialsId: 'vault-role-id', variable: 'VAULT_ROLE_ID'),
                            string(credentialsId: 'vault-secret-id', variable: 'VAULT_SECRET_ID')
                        ]) {
                            sh '''
                                apk add --no-cache curl 2>/dev/null || true

                                RESPONSE=$(curl -s --request POST \
                                    --data "{\\"role_id\\": \\"${VAULT_ROLE_ID}\\", \\"secret_id\\": \\"${VAULT_SECRET_ID}\\"}" \
                                    ${VAULT_ADDR}/v1/auth/approle/login)

                                VAULT_TOKEN=$(echo "$RESPONSE" | grep -o '"client_token":"[^"]*' | cut -d'"' -f4)

                                if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
                                    echo "âŒ Vault login failed"
                                    exit 1
                                fi

                                echo "$VAULT_TOKEN" > /workspace/.vault-token
                                echo "âœ… Vault authenticated"
                            '''
                        }
                    }
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
                script {
                    echo "ðŸ“¦ Building ${APP_NAME}:${BUILD_TAG}"
                    echo "ðŸ“ Git commit: ${GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Read Secrets') {
            steps {
                container('shell') {
                    script {
                        echo "ðŸ”‘ Reading secrets from Vault..."

                        sh '''
                            apk add --no-cache curl 2>/dev/null || true
                            export VAULT_TOKEN=$(cat /workspace/.vault-token)

                            # GitHub credentials
                            RESPONSE=$(curl -s -H "X-Vault-Token: ${VAULT_TOKEN}" ${VAULT_ADDR}/v1/secret/data/ci/github)
                            GIT_USERNAME=$(echo "$RESPONSE" | grep -o '"username":"[^"]*' | cut -d'"' -f4)
                            GIT_TOKEN=$(echo "$RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4)

                            echo "GIT_USERNAME=${GIT_USERNAME}" > /workspace/.git-creds
                            echo "GIT_TOKEN=${GIT_TOKEN}" >> /workspace/.git-creds

                            echo "âœ… Secrets loaded"
                        '''
                    }
                }
            }
        }

        stage('Build with Kaniko') {
            steps {
                container('kaniko') {
                    script {
                        echo "ðŸ—ï¸  Building ${APP_NAME} with Kaniko..."

                        sh """
                            /kaniko/executor \
                                --context=${WORKSPACE}/apps/${APP_NAME} \
                                --dockerfile=${WORKSPACE}/apps/${APP_NAME}/Dockerfile \
                                --destination=${IMAGE_NAME}:${BUILD_TAG} \
                                --destination=${IMAGE_NAME}:latest \
                                --cache=true \
                                --cache-ttl=24h \
                                --compressed-caching=false \
                                --snapshot-mode=redo \
                                --log-format=text \
                                --verbosity=info \
                                --build-arg NEXT_PUBLIC_API_URL=http://webapi-service:5000

                            echo "âœ… Image built and pushed: ${IMAGE_NAME}:${BUILD_TAG}"
                        """
                    }
                }
            }
        }

        stage('Security Scan') {
            steps {
                container('trivy') {
                    script {
                        echo "ðŸ” Scanning image for vulnerabilities..."

                        sh """
                            trivy image \
                                --severity HIGH,CRITICAL \
                                --exit-code 0 \
                                --no-progress \
                                --timeout 10m \
                                ${IMAGE_NAME}:${BUILD_TAG} || echo "âš ï¸  Vulnerabilities found"

                            echo "âœ… Security scan completed"
                        """
                    }
                }
            }
        }

        stage('Update Manifests') {
            steps {
                container('shell') {
                    script {
                        echo "ðŸ“ Updating Kubernetes manifests..."

                        sh '''
                            source /workspace/.git-creds

                            git clone ${K8S_REPO} k8s-manifests
                            cd k8s-manifests

                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@example.com"

                            # Update deployment
                            sed -i "s|image: harbor.local/sample-app/webapp:.*|image: ${IMAGE_NAME}:${BUILD_TAG}|g" manifests/dev/webapp-deployment.yaml
                            sed -i "s|image: harbor.local/sample-app/webapp:.*|image: ${IMAGE_NAME}:${BUILD_TAG}|g" manifests/dev/webapp-deployment.vault.yaml 2>/dev/null || true

                            git add manifests/dev/
                            git commit -m "Update webapp to ${BUILD_TAG}

Built by: Jenkins
Job: ${JOB_NAME}
Build: ${BUILD_NUMBER}
Commit: ${GIT_COMMIT_SHORT}" || echo "No changes"

                            git push https://\${GIT_USERNAME}:\${GIT_TOKEN}@github.com/chanon-dev/poc-deploy-k8s.git ${K8S_BRANCH}

                            echo "âœ… Manifests updated"
                        '''
                    }
                }
            }
        }

        stage('Trigger Argo CD') {
            steps {
                container('shell') {
                    script {
                        echo "ðŸš€ Triggering Argo CD sync..."

                        sh '''
                            apk add --no-cache curl 2>/dev/null || true
                            export VAULT_TOKEN=$(cat /workspace/.vault-token)

                            # Get Argo CD token
                            ARGOCD_TOKEN=$(curl -s -H "X-Vault-Token: ${VAULT_TOKEN}" \
                                ${VAULT_ADDR}/v1/secret/data/ci/argocd | \
                                grep -o '"token":"[^"]*' | cut -d'"' -f4)

                            # Sync application
                            curl -k -X POST \
                                -H "Authorization: Bearer ${ARGOCD_TOKEN}" \
                                https://argocd.local/api/v1/applications/webapp-dev/sync || echo "âš ï¸  Sync triggered"

                            echo "âœ… Argo CD notified"
                        '''
                    }
                }
            }
        }

        stage('Record Build') {
            steps {
                container('shell') {
                    script {
                        echo "ðŸ“Š Recording build metadata..."

                        sh '''
                            apk add --no-cache curl 2>/dev/null || true
                            export VAULT_TOKEN=$(cat /workspace/.vault-token)

                            curl -s -H "X-Vault-Token: ${VAULT_TOKEN}" \
                                -H "Content-Type: application/json" \
                                -X POST \
                                ${VAULT_ADDR}/v1/secret/data/ci/builds/webapp/${BUILD_NUMBER} \
                                -d "{\\"data\\": {\\"app\\": \\"webapp\\", \\"build\\": \\"${BUILD_NUMBER}\\", \\"commit\\": \\"${GIT_COMMIT_SHORT}\\", \\"image\\": \\"${IMAGE_NAME}:${BUILD_TAG}\\", \\"timestamp\\": \\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\\"}}" \
                                > /dev/null

                            echo "âœ… Build recorded"
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo "âœ… Webapp deployment successful!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ Image: ${IMAGE_NAME}:${BUILD_TAG}"
            echo "ðŸ·ï¸  Also tagged as: ${IMAGE_NAME}:latest"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        }

        failure {
            echo "âŒ Webapp deployment failed!"
        }

        always {
            script {
                container('shell') {
                    sh 'rm -f /workspace/.vault-token /workspace/.git-creds 2>/dev/null || true'
                }
            }
        }
    }
}
